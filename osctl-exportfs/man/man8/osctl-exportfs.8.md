# osctl-exportfs 8                2019-09-10                             19.03.0

## NAME
`osctl-exportfs` - manage dedicated NFS servers for filesystem exports

## SYNOPSIS
`osctl-exportfs` [*global options*] *command* [*command options*] [*arguments...*]

## DESCRIPTION
`osctl-exportfs` manages dedicated NFS servers run in lightweight containers
for that purpose. Each NFS server runs in its own network namespace, which is
useful for accounting and ensuring quality of service. Each NFS server also has
a custom set of exported filesystems.

`osctl-exportfs` utility can only be used in conjuction with the `osctl-exportfs`
service, which has to be enabled in system configuration using option
`osctl.exportfs.enable`, see vpsadminos-configuration.nix(5). The created NFS
servers are not persistent. The servers and their configuration is lost when
the host machine is rebooted.

Each NFS server lives in its own privileged container composed of mount, network,
UTS and PID namespace, but sharing the host's `/nix/store`. Servers can be
started either interactively using command `server spawn` or put into `runit`
supervision tree using command `server start`. Servers monitored by `runit` are
automatically restarted in case they inadvertedly stop.

## COMMANDS
`server ls`
  List configured NFS servers and their state.

`server new` *name*
  Add a new NFS server identified by *name*.

`server del` *name*
  Delete configured NFS server identified by *name*.

`server spawn` *name* *address*
  Start NFS server *name* and export its filesystems. The server will be
  listening on *address*, which has to be an IPv4 address without prefix.

  The server will run in the foreground, it can be stopped by sending the
  process `SIGINT` or `SIGTERM` signal.

`server start` *name* *address*
  Start NFS server *name*, but put in a `runit` supervision tree. A `runsv`
  service is created in `/run/osctl-exportfs/runsvdir`, which is picked up
  and started by `runsvdir` running as part of `osctl-exportfs` service.

`server stop` *name*
  Remove the service for NFS server *name* from `runit` supervision tree and
  stop it.

`server restart` *name* *address*
  Restart NFS server *name*, which has to be running in a `runit` supervision
  tree.

`export ls` [*server*]
  List all exports or exports configured on *server*.

`export add` *options* *server*
  Export directory using NFS server *server*.

    `--directory` *dir*
      Directory from the host namespace to export. Required.

    `--as` *dir*
      Change the path the directory will be exported as. Optional.

    `--host` *host*
      Which hosts will be allowed to mount the export. Required.

    `--options` *options*
      Optional NFS export options.

`export del` *options* *server*
  Remove export from NFS server *server* with matching *dir* and *host*.
    
    `--directory` *dir*
      Exported directory.
    
    `--host` *host*
      Hosts allowed to mount the exported directory.

## FILES
All configured NFS servers reside in `/run/osctl-exportfs`, which is initialized
by the `osctl-exportfs` service:

```
/run/osctl-exportfs
├── rootfs/
├── runsvdir/
├── servers/
└── template/
```

Directory `rootfs/` is used to construct a new root filesystem for the server
container and is always empty on the host. Directory `runsvdir/` is monitored by
the `runsvdir` program from `runit`, i.e. services for servers started using
`server start` are put into this directory. Directory `servers/` contains
a subdirectory per NFS server, each with its own configuration. Directory
`template/` contains `runit` configuration and services which is reused in
NFS server containers.

## Server directory
Each server directory has the following structure:

```
<server name>
├── runit/
├── runsv/
├── shared/
├── state/
├── exports.yml
├── exports.exportfs
└── [pid]
```

Directory `runit/` contains standard `runit` configuration for the NFS container
system, see runit-init(8) and runit(8). The files are linked from
`/run/osctl-exportfs/template`.

Directory `runsv/` is the service generated by command `server start`. It is
linked to `/run/osctl-exportfs/runsvdir` as long as the server should be running.

Directory `shared/` is used to propagate new mounts from the host to the NFS
container in order to add new exports.

NFS server state, normally found in `/var/lib/nfs` is stored in directory
`state/`.

`exports.yml` is a list of configured exports, it is used only by
`osctl-exportfs` to generate `exports.exportfs`, which is then read by
exportfs(8) to actually configure the containerized NFS server.

If the server is running, the PID of its init is stored in file `pid`.

## BUGS
Report bugs to https://github.com/vpsfreecz/vpsadminos/issues.

## ABOUT
`osctl-exportfs` is a part of [vpsAdminOS](https://github.com/vpsfreecz/vpsadminos).
